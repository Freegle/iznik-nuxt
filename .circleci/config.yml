# Android: runs in /home/circleci/project
# Apple: runs in /Users/distiller/project as user distiller
version: 2.1

orbs:
  node: circleci/node@4.1.0
  android: circleci/android@1.0.3

################
workflows:
  version: 2
  build-and-publish:
    jobs:
      #- hold: # Job needs approval to run
      #    type: approval      
      - build-and-publish-apple:
          filters:
            branches:
              only:
                - app-publish
      #    requires:
      #      - hold
      - build-and-publish-android:
          filters:
            branches:
              only:
                - app-publish
      #    requires:
      #      - hold

################
################ APPLE
jobs:
  build-and-publish-apple:
    macos:
      # https://circleci.com/docs/2.0/testing-ios/#supported-xcode-versions
      xcode: "12.4.0" # 11.3.1
    steps:
      - checkout
      - node/install:
          lts: true
          #install-npm: false
          #node-version: "14.15.4"
          npm-version: "6.14.10"
      - run: npm -v; node -v # 6.14.11 v14.15.4

      ################
      - run:
          name: == Get ionic-plugin-deeplinks
          command: echo "Get ionic-plugin-deeplinks"
      - run: cd ..;git clone https://github.com/Freegle/ionic-plugin-deeplinks.git

      ################
      - run:
          name: == Decrypt secrets and set up signing
          command: echo "Decrypt secrets"
      - run: openssl version; tar --version; java -version
      #- run: cd mobile; openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; openssl enc -aes-256-cbc -md sha512 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; tar -xvf circleci-secrets.tar --no-same-owner; ls -l secrets

      - run: chmod +x mobile/add-key.sh
      - run: ./mobile/add-key.sh

      ################
      - run:
          name: == Extract app version strings
          command: echo "Extract app version strings"
      - run: grep -o "MOBILE_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MOBILE_VERSION = '//; s/'.*//" >MOBILE_VERSION.txt
      - run: echo "export MOBILE_VERSION=$(<MOBILE_VERSION.txt)" >> $BASH_ENV
      - run: echo $MOBILE_VERSION

      - run: grep -o "MODTOOLS_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MODTOOLS_VERSION = '//; s/'.*//" >MODTOOLS_VERSION.txt
      - run: echo "export MODTOOLS_VERSION=$(<MODTOOLS_VERSION.txt)" >> $BASH_ENV
      - run: echo $MODTOOLS_VERSION

      - run: mkdir releases

################
      - run:
          name: == Install cordova and fix permissions
          command: echo "Install cordova and fix permissions"
      - run: sudo npm install -g cordova@9.0.0 rimraf
      - run: npm install

      # Permissions fixes to let cordova run OK - may not all be needed
      - run: mkdir -p ~/Library/Preferences/insight-nodejs
      - run: sudo chmod -R 777 ~/Library
      - run: sudo chmod -R 777 ~/.config
      - run: mkdir -p ~/.config/configstore
      - run: ls -l ~/.config/configstore

################
# FREEGLE app
      - run:
          name: == Make Freegle app debug and release builds and upload to iTunes
          command: echo "Make Freegle app"
      - run: npm run fdapp

      - run: mkdir ../iznik-nuxt-app
      - run: cd ../iznik-nuxt-app; ln -s ../project/mobile/freegle/ios/config.xml config.xml
      - run: cd ../iznik-nuxt-app; ln -s ../project/mobile/freegle/ios/package.json package.json
      - run: cd ../iznik-nuxt-app; ln -s ../project/mobile/freegle/icons icons
      - run: cd ../iznik-nuxt-app; ln -s ../project/mobile/freegle/package-assets package-assets
      - run: cd ../iznik-nuxt-app; ln -s ../project/mobile/freegle/scripts scripts
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/secrets/GoogleService-Info.plist GoogleService-Info.plist
      - run: cd ../iznik-nuxt-app; ln -s ../project/dist www

      - run: cd ../iznik-nuxt-app; cordova platform rm ios
      - run: cd ../iznik-nuxt-app; cordova platform add ios@6.2.0

      # Fix cordova-ios
      - run: cd ../iznik-nuxt-app; sed -i '' "s/PROVISIONING_PROFILE =/PROVISIONING_PROFILE_SPECIFIER =/" platforms/ios/cordova/lib/build.js

      # Build debug build
      - run: cd ../iznik-nuxt-app; cordova build --debug --device --codeSignIdentity="iPhone Distribution" --developmentTeam="$iosDeveloper" --packageType="ad-hoc" --automaticProvisioning="false" --provisioningProfile="Freegle adhoc 0221" >buildlogdebug.txt
      - run: cd ../iznik-nuxt-app; tail -n 5 buildlogdebug.txt
      - run: cd ../iznik-nuxt-app; cp platforms/ios/build/device/Freegle.ipa ../project/releases/Freegle-ios-app-$MOBILE_VERSION-debug-$(date +'%Y%m%d%H%M%S').ipa

      # Build release build and publish
      - run: cd ../iznik-nuxt-app; cordova build --release --device --codeSignIdentity="iPhone Distribution" --developmentTeam="$iosDeveloper" --packageType="app-store" --automaticProvisioning="false" --provisioningProfile="Freegle 0421"  >buildlogrelease.txt
      - run: cd ../iznik-nuxt-app; tail -n 5 buildlogrelease.txt
      - run: cd ../iznik-nuxt-app; cp platforms/ios/build/device/Freegle.ipa ../project/releases/Freegle-ios-app-$MOBILE_VERSION-release-$(date +'%Y%m%d%H%M%S').ipa
      - run: cd ../iznik-nuxt-app; xcrun altool --upload-app --type ios --file "platforms/ios/build/device/Freegle.ipa" --username $AppleUserId --password "$AppleAppSpecificPwd" || true

################
# MODTOOLS app
      - run:
          name: == Make ModTools app debug and release builds and upload to iTunes
          command: echo "Make ModTools app"
      - run: npm run mtapp
      - run: mkdir ../iznik-nuxt-mt
      - run: cd ../iznik-nuxt-mt; ln -s ../project/mobile/modtools/ios/config.xml config.xml
      - run: cd ../iznik-nuxt-mt; ln -s ../project/mobile/modtools/ios/package.json package.json
      - run: cd ../iznik-nuxt-mt; ln -s ../project/mobile/modtools/icons icons
      - run: cd ../iznik-nuxt-mt; ln -s ../project/mobile/modtools/package-assets package-assets
      - run: cd ../iznik-nuxt-mt; ln -s ../project/mobile/modtools/scripts scripts
      - run: cd ../iznik-nuxt-mt; cp ../project/mobile/secrets/GoogleService-Info.plist GoogleService-Info.plist
      - run: cd ../iznik-nuxt-mt; ln -s ../project/dist www
      - run: cd ../iznik-nuxt-mt; cordova platform rm ios
      - run: cd ../iznik-nuxt-mt; cordova platform add ios@6.2.0

      # Fix cordova-ios
      - run: cd ../iznik-nuxt-mt; sed -i '' "s/PROVISIONING_PROFILE =/PROVISIONING_PROFILE_SPECIFIER =/" platforms/ios/cordova/lib/build.js

      # Build debug build
      - run: cd ../iznik-nuxt-mt; cordova build --debug --device --codeSignIdentity="iPhone Distribution" --developmentTeam="$iosDeveloper" --packageType="ad-hoc" --automaticProvisioning="false" --provisioningProfile="ModTools adhoc 0221" >buildlogdebug.txt
      - run: cd ../iznik-nuxt-mt; tail -n 5 buildlogdebug.txt
      - run: cd ../iznik-nuxt-mt; cp platforms/ios/build/device/ModTools.ipa ../project/releases/ModTools-ios-app-$MODTOOLS_VERSION-debug-$(date +'%Y%m%d%H%M%S').ipa

      # Build release build and publish
      - run: cd ../iznik-nuxt-mt; cordova build --release --device --codeSignIdentity="iPhone Distribution" --developmentTeam="$iosDeveloper" --packageType="app-store" --automaticProvisioning="false" --provisioningProfile="ModTools 0221"  >buildlogrelease.txt
      - run: cd ../iznik-nuxt-mt; tail -n 5 buildlogrelease.txt
      - run: cd ../iznik-nuxt-mt; cp platforms/ios/build/device/ModTools.ipa ../project/releases/ModTools-ios-app-$MODTOOLS_VERSION-release-$(date +'%Y%m%d%H%M%S').ipa
      - run: cd ../iznik-nuxt-mt; xcrun altool --upload-app --type ios --file "platforms/ios/build/device/ModTools.ipa" --username $AppleUserId --password "$AppleAppSpecificPwd" || true

################
# UPLOAD TO GITHUB AS NEW TAGGED RELEASE
      - run:
          name: == Upload created ipas as a tagged github release
          command: echo "Upload to github"
      - run: git config --local user.name "$gitusername"
      - run: git config --local user.email "$gitemail"
      - run: echo "export CIRCLECI_TAG=circleci-ios-builds-fd$MOBILE_VERSION-mt$MODTOOLS_VERSION-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)" >> $BASH_ENV
      - run: echo $CIRCLECI_TAG
      - run: git tag $CIRCLECI_TAG

      - run: brew install ghr

      - run: ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${CIRCLECI_TAG} ./releases/

################
# STORE RELEASE IN CIRCLE-CI ARTIFACTS
      - run:
          name: == Store built ipas as circle-ci artifacts
          command: echo "Store as circle-ci artifacts"
      - store_artifacts:
          path: ./releases

################
################ ANDROID

  build-and-publish-android:  
    #executor: node/default
    executor:
      #name: android/android
      name: android/android-machine
      #resource-class: large
      #sdk-version: '30'
    #docker:
    #  - image: cimg/android:30-0 # https://circleci.com/developer/images/image/cimg/openjdk
###      - image: circleci/android:api-28
#      - image: circleci/android:api-24-alpha # brings in suitably old openjdk
##      - image: circleci/jdk8:0.1.1
    environment:
      # JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64
      # ANDROID_HOME: /usr/local/android-sdk-linux
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3g
      _JAVA_OPTIONS: "-Xmx3g"
      TERM: dumb
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
    steps:
      - run:
          name: == Install
          command: echo "Install"
      - checkout
      - android/accept-licenses
      #- node/install:
      #    lts: true
      #    #install-npm: false
      #    #node-version: "14.15.4"
      #    npm-version: "6.14.11"
      - run: npm -v; node -v # OK: 7.5.2 v14.15.4  # 6.14.11 v14.15.4 # Seems OK: 7.10.0 14.16.1

      - run: npm install
      - run: npm install -g cordova rimraf # @9.0.0
      - run: cordova -v

################
      - run:
          name: == Get ionic-plugin-deeplinks
          command: echo "Get ionic-plugin-deeplinks"
      - run: cd ..;git clone https://github.com/Freegle/ionic-plugin-deeplinks.git

################
      - run:
          name: == Get @havesource/cordova-plugin-push
          command: echo "Get @havesource/cordova-plugin-push"
      - run: cd ..;git clone https://github.com/havesource/cordova-plugin-push.git

################
      - run:
          name: == Decrypt secrets 
          command: echo "Decrypt secrets"
      - run: sudo apt update
      - run: openssl version; tar --version; java -version
      #- run: cd mobile; openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; openssl enc -aes-256-cbc -md sha512 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; tar -xvf circleci-secrets.tar --no-same-owner; ls -l secrets

################
      #- run:
      #    name: == Install gradle
      #    command: echo "Install gradle"
      #- run: sudo apt-get install unzip
      #- run: wget -O ~/gradle-5.4.1-bin.zip https://services.gradle.org/distributions/gradle-5.4.1-bin.zip
      #- run: sudo mkdir /opt/gradle
      #- run: sudo unzip -d /opt/gradle ~/gradle-5.4.1-bin.zip
      #- run: sudo echo "export GRADLE_HOME=/opt/gradle/gradle-5.4.1" >> $BASH_ENV
      #- run: sudo echo "export PATH=$GRADLE_HOME/bin:$PATH" >> $BASH_ENV
      - run: gradle -v
      
################
      - run:
          name: == Extract app version strings
          command: echo "Extract app version strings"
      - run: grep -o "MOBILE_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MOBILE_VERSION = '//; s/'.*//" >MOBILE_VERSION.txt
      - run: echo "export MOBILE_VERSION=$(<MOBILE_VERSION.txt)" >> $BASH_ENV
      #- run: echo $MOBILE_VERSION
      - run: grep -o "MODTOOLS_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MODTOOLS_VERSION = '//; s/'.*//" >MODTOOLS_VERSION.txt
      - run: echo "export MODTOOLS_VERSION=$(<MODTOOLS_VERSION.txt)" >> $BASH_ENV
      #- run: echo $MODTOOLS_VERSION

      - run: mkdir releases
################
# FREEGLE APP
      - run:
          name: == Make Freegle app debug and release builds and upload to Google Play beta
          command: echo "Make Freegle app"
      - run: npm run fdapp
      - run: pwd; ls -l mobile/freegle/scripts
      - run: mkdir ../iznik-nuxt-app
      - run: "cd ../iznik-nuxt-app; 
        ln -s ../project/mobile/freegle/android/config.xml config.xml;
        ln -s ../project/mobile/freegle/android/package.json package.json;
        ln -s ../project/mobile/freegle/icons icons;
        ln -s ../project/mobile/freegle/package-assets package-assets;
        ln -s ../project/mobile/freegle/scripts scripts;
        chmod +x scripts/before_build.sh;
        chmod +x scripts/remove_permissions.js;
        cp ../project/mobile/secrets/google-services.json google-services.json;
        cp ../project/mobile/freegle/alert.mp3 alert.mp3;
        ln -s ../project/dist www;
        cordova platform rm android;
        cordova platform add android@10.0.1
      "
      #  set ssh_strict_host_key_checking: true;
      #  cordova plugin add https://github.com/havesource/cordova-plugin-push
      # cordova plugin add @havesource/cordova-plugin-push
      #cordova plugin rm havesource-cordova-plugin-push;
      #cordova plugin rm @havesource/cordova-plugin-push;

      #- run: $ANDROID_HOME/tools/android list target

      #- run: $ANDROID_HOME/tools/bin/sdkmanager --list

      #- run: $ANDROID_HOME/tools/bin/sdkmanager --list | grep "build-tools"

      #- run: $ANDROID_HOME/tools/bin/sdkmanager --list | sed -e '/Available Packages/q'

      - run: echo $ANDROID_HOME
      - run: echo $JAVA_HOME
      # Build debug build
      - run: cd ../iznik-nuxt-app; cordova build --debug -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-app; cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../project/releases/Freegle-android-app-$MOBILE_VERSION-debug-$(date +'%Y%m%d%H%M%S').apk

      # Build release build
      - run: cd ../iznik-nuxt-app; cordova build --release -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-app; cp platforms/android/app/build/outputs/bundle/release/app-release.aab ../project/releases/Freegle-android-app-$MOBILE_VERSION-release-$(date +'%Y%m%d%H%M%S').aab

      - run: ls -l releases

      # Publish to Google Play beta track
      # https://haseebmajid.dev/blog/auto-publish-react-native-to-android-store-with-gitlab-ci
      - run: cd ../iznik-nuxt-app; cat platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; sed -i "/mavenCentral/amaven { url 'https://plugins.gradle.org/m2/' }" platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; sed -i "/classpath/aclasspath 'com.github.triplet.gradle:play-publisher:2.4.1'" platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/build-extras.gradle platforms/android/app
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/secrets/api-freegle-google-play-deployment.json platforms/android/app
      - run: cd ../iznik-nuxt-app/platforms/android; gradle publishReleaseApk || true # Ignore errors ie if versionCode already submitted

################
# MODTOOLS APP
      - run:
          name: == Make ModTools app debug and release builds and upload to Google Play beta
          command: echo "Make ModTools app"
      - run: npm run mtapp
      - run: pwd; ls -l mobile/modtools/scripts
      - run: mkdir ../iznik-nuxt-mt
      - run: "cd ../iznik-nuxt-mt; 
        ln -s ../project/mobile/modtools/android/config.xml config.xml;
        ln -s ../project/mobile/modtools/android/package.json package.json;
        ln -s ../project/mobile/modtools/icons icons;
        ln -s ../project/mobile/modtools/package-assets package-assets;
        ln -s ../project/mobile/modtools/scripts scripts;
        chmod +x scripts/before_build.sh;
        cp ../project/mobile/secrets/google-services.json google-services.json;
        cp ../project/mobile/modtools/alert.mp3 alert.mp3;
        ln -s ../project/dist www;
        cordova platform rm android;
        cordova platform add android@10.0.1
      "

      - run: echo $ANDROID_HOME
      - run: echo $JAVA_HOME
      # Build debug build
      - run: cd ../iznik-nuxt-mt; cordova build --debug -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-mt; cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../project/releases/ModTools-android-app-$MODTOOLS_VERSION-debug-$(date +'%Y%m%d%H%M%S').apk

      # Build release build
      - run: cd ../iznik-nuxt-mt; cordova build --release -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-mt; cp platforms/android/app/build/outputs/bundle/release/app-release.aab ../project/releases/ModTools-android-app-$MODTOOLS_VERSION-release-$(date +'%Y%m%d%H%M%S').apk

      - run: ls -l releases

      # Publish to Google Play beta track
      # https://haseebmajid.dev/blog/auto-publish-react-native-to-android-store-with-gitlab-ci
      - run: cd ../iznik-nuxt-app; cat platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; sed -i "/mavenCentral/amaven { url 'https://plugins.gradle.org/m2/' }" platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/repositories.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; sed -i "/classpath/aclasspath 'com.github.triplet.gradle:play-publisher:2.4.1'" platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/build-extras.gradle platforms/android/app
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/secrets/api-freegle-google-play-deployment.json platforms/android/app
      - run: cd ../iznik-nuxt-app/platforms/android; gradle publishReleaseApk || true # Ignore errors ie if versionCode already submitted

################
# UPLOAD TO GITHUB AS NEW TAGGED RELEASE
      - run:
          name: == Upload created apks as a tagged github release
          command: echo "Upload to github"
      - run: git config --local user.name "$gitusername"
      - run: git config --local user.email "$gitemail"
      - run: echo "export CIRCLECI_TAG=circleci-android-builds-fd$MOBILE_VERSION-mt$MODTOOLS_VERSION-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)" >> $BASH_ENV
      - run: echo $CIRCLECI_TAG
      - run: git tag $CIRCLECI_TAG

      # https://circleci.com/blog/publishing-to-github-releases-via-circleci/
      # https://github.com/tcnksm/ghr
      - run: wget https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_386.tar.gz
      - run: tar -xvzf ghr_v0.13.0_linux_386.tar.gz
      - run: ls -l ghr_v0.13.0_linux_386
      - run: chmod +x ghr_v0.13.0_linux_386/ghr

      - run: ghr_v0.13.0_linux_386/ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${CIRCLECI_TAG} ./releases/

################
# STORE RELEASE IN CIRCLE-CI ARTIFACTS
      - run:
          name: == Store built apks as circle-ci artifacts
          command: echo "Store as circle-ci artifacts"
      - store_artifacts:
          path: ./releases
