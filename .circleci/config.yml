# https://circleci.com/developer/orbs/orb/circleci/node
# https://circleci.com/developer/orbs/orb/circleci/gradle
# https://flexpoint.tech/2017/08/29/using-oracles-jdk-in-circleci-with-gradle/
# https://circleci.com/docs/2.0/language-java/

# https://medium.com/tarmac/continuous-delivery-to-test-flight-with-ionic-and-cordova-on-circleci-without-fastlane-58447324f38a

# https://github.com/ngx-rocket/generator-ngx-rocket/issues/162
# https://github.com/ngx-rocket/generator-ngx-rocket/pull/364/commits/b41a54eb3a465ffe4767412971ec99a7c2ddaf23
# https://github.com/ngx-rocket/circleci-dockerfiles/blob/master/cordova/images/Dockerfile
# Runs in /home/circleci/project
version: 2.1

orbs:
  node: circleci/node@4.1.0
  android: circleci/android@0.2.3
  gradle: circleci/gradle@2.2.0

workflows:
  version: 2
  android:
    jobs:
      - build-and-deploy-android:
          filters:
            branches:
              only:
                - app

jobs:
  build-and-deploy-android:  
    #executor: node/default
    executor:
      name: android/android
      sdk-version: '28'
    docker:
###      - image: circleci/android:api-28
      - image: circleci/android:api-24-alpha # brings in suitably old openjdk
##      - image: circleci/jdk8:0.1.1
    environment:
###      JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64
###      ANDROID_HOME: /usr/local/android-sdk-linux
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3g
      _JAVA_OPTIONS: "-Xmx3g"
      TERM: dumb
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
    steps:
##      - run: sudo apt update
##      - run: sudo apt install -y curl git openssl tar

      - checkout
##      - run: sudo curl -sL https://deb.nodesource.com/setup_12.x -o nodesource_setup.sh
##      - run: sudo sh ./nodesource_setup.sh
##      - run: sudo apt install -y nodejs
      - android/accept-licenses
      - node/install:
          lts: true
          #node-version: '12.20'
      - run: npm -v
      - run: node -v

      - run: npm install
      - run: npm install -g cordova@9.0.0
      - run: npm install -g rimraf
      - run: cordova -v

################
      - run: sudo apt update
      #- run: sudo apt-get install tar
      - run: openssl version; tar --version; java -version
      #- run: cd mobile; openssl enc -aes-256-cbc -md sha512 -pbkdf2 -iter 100000 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; openssl enc -aes-256-cbc -md sha512 -salt -d -in circleci-secrets.tar.enc -out circleci-secrets.tar -k $CIRCLE_TAR_PWD
      - run: cd mobile; tar -xvf circleci-secrets.tar --no-same-owner; ls -l secrets

################
      - run: sudo apt-get install unzip
      - run: wget -O ~/gradle-5.4.1-bin.zip https://services.gradle.org/distributions/gradle-5.4.1-bin.zip
      - run: sudo mkdir /opt/gradle
      - run: sudo unzip -d /opt/gradle ~/gradle-5.4.1-bin.zip
      - run: sudo echo "export GRADLE_HOME=/opt/gradle/gradle-5.4.1" >> $BASH_ENV
      - run: sudo echo "export PATH=$GRADLE_HOME/bin:$PATH" >> $BASH_ENV
      - run: gradle -v
      #- run: ./gradlew --version
      #- run: ./gradlew dependencies
      
################
      - run: grep -o "MOBILE_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MOBILE_VERSION = '//; s/'.*//" >MOBILE_VERSION.txt
      - run: echo "export MOBILE_VERSION=$(<MOBILE_VERSION.txt)" >> $BASH_ENV
      #- run: echo $MOBILE_VERSION
      - run: grep -o "MODTOOLS_VERSION = '[^']*'" nuxt.config.js | sed -e "s/.*MODTOOLS_VERSION = '//; s/'.*//" >MODTOOLS_VERSION.txt
      - run: echo "export MODTOOLS_VERSION=$(<MODTOOLS_VERSION.txt)" >> $BASH_ENV
      #- run: echo $MODTOOLS_VERSION


      - run: mkdir releases
      - run: npm run fdapp
      - run: pwd; ls -l mobile/freegle/scripts
      - run: mkdir ../iznik-nuxt-app
      - run: "cd ../iznik-nuxt-app; 
        ln -s ../project/mobile/freegle/android/config.xml config.xml;
        ln -s ../project/mobile/freegle/android/package.json package.json;
        ln -s ../project/mobile/freegle/icons icons;
        ln -s ../project/mobile/freegle/package-assets package-assets;
        ln -s ../project/mobile/freegle/scripts scripts;
        chmod +x scripts/before_build.sh;
        chmod +x scripts/remove_permissions.js;
        cp ../project/mobile/secrets/google-services.json google-services.json;
        ln -s ../project/dist www;
        cordova platform rm android;
        cordova platform add android@8.1.0
      "

      - run: echo $ANDROID_HOME
      - run: echo $JAVA_HOME
      # Build debug build
      - run: cd ../iznik-nuxt-app; cordova build --debug -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-app; cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../project/releases/Freegle-android-app-$MOBILE_VERSION-debug-$(date +'%Y%m%d%H%M%S').apk

      # Build release build
      - run: cd ../iznik-nuxt-app; cordova build --release -- --keystore="../project/mobile/secrets/android-chrisphdcccom.new.keystore" --storePassword="$storepass" --password="$keypass" --alias="Freegle Ltd Chris"
      - run: cd ../iznik-nuxt-app; cp platforms/android/app/build/outputs/apk/release/app-release.apk ../project/releases/Freegle-android-app-$MOBILE_VERSION-release-$(date +'%Y%m%d%H%M%S').apk

      - run: ls -l releases

      # Publish to Google Play beta track
      - run: cd ../iznik-nuxt-app; sed -i "/3.3.0'/aclasspath 'com.github.triplet.gradle:play-publisher:2.0.0-rc1'" platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cat platforms/android/build.gradle
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/build-extras.gradle platforms/android/app
      - run: cd ../iznik-nuxt-app; cp ../project/mobile/secrets/api-freegle-google-play-deployment.json platforms/android/app
      - run: cd ../iznik-nuxt-app/platforms/android; gradle app:publishReleaseApk || true # Ignore errors ie if versionCode already submitted

      - run: git config --local user.name "$gitusername"
      - run: git config --local user.email "$gitemail"
      - run: echo "export CIRCLECI_TAG=circleci-android-builds-$MOBILE_VERSION-$MODTOOLS_VERSION-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)" >> $BASH_ENV
      #- run: env | grep '^CIRCLECI_TAG='
      - run: echo $CIRCLECI_TAG
      - run: git tag $CIRCLECI_TAG
