<template>
  <div v-observe-visibility="visible">
    <div v-if="src && show">
      <a @click="click">
        <b-card-img :src="src" fluid class="clickme" />
      </a>
      <div id="adnotice" class="d-flex justify-content-end text-muted small">
        Advertisement. Why am I seeing this?
      </div>
      <b-tooltip target="adnotice">
        Showing this generates a bit of income for Freegle, which helps us keep going.
      </b-tooltip>
    </div>
  </div>
</template>
<script>
import turfpoint from 'turf-point'
import turfpolygon from 'turf-polygon'
import turfbooleanPointInPolygon from '@turf/boolean-point-in-polygon'
import VueObserveVisibility from 'vue-observe-visibility'
import Vue from 'vue'

if (process.client) {
  Vue.use(VueObserveVisibility)
}

export default {
  props: {
    variant: {
      type: String,
      required: true
    }
  },
  data: function() {
    return {
      shown: false,
      chosen: null,
      uid: 'lovejunk4'
    }
  },
  computed: {
    key() {
      return this.uid + '-' + this.variant
    },
    src() {
      return '/lovejunk/' + this.chosen
    },
    show() {
      // We want to show the ad if the user's location is within the area LoveJunk cover.
      if (this.me && (this.me.lat || this.me.lng)) {
        // const point = turfpoint([-0.1281, 51.508])
        const point = turfpoint([this.me.lng, this.me.lat])

        const poly = turfpolygon([
          [
            [0.7903302490433317, 51.7190510294985],
            [0.9880841552933317, 51.79725493114429],
            [1.1199200927933317, 51.78196482440004],
            [1.1089337646683317, 51.87532343646985],
            [0.9880841552933317, 52.00062802644126],
            [0.8562482177933317, 52.03443407303321],
            [0.7793439209183317, 51.932939275167165],
            [0.6749738037308317, 51.94309910551736],
            [0.4827130615433317, 52.01753424304129],
            [0.3728497802933317, 51.96002704361278],
            [0.2574933349808317, 51.92955215375683],
            [0.04325993654333171, 51.939712751039984],
            [-0.1325213134566683, 52.02767490736911],
            [-0.2204119384566683, 52.10871747603098],
            [-0.3522478759566683, 52.17614063120053],
            [-0.4785906493941683, 52.21991095781428],
            [-0.6488787353316683, 52.23337007960059],
            [-0.7587420165816683, 52.179509109827585],
            [-0.8905779540816683, 52.14581284282836],
            [-1.0224138915816683, 52.1019695458063],
            [-1.0883318603316683, 52.06314912942377],
            [-1.3492571533004183, 52.090158210854575],
            [-1.4412676513472933, 52.033589233201006],
            [-1.6788469970504183, 51.91938925554042],
            [-1.7008196533004183, 51.76156995189717],
            [-1.7145525634566683, 51.65604957898863],
            [-1.6925799072066683, 51.56052919889976],
            [-1.6678606689254183, 51.55199081867509],
            [-1.6623675048629183, 51.54515896039326],
            [-1.6541277587691683, 51.528074826119635],
            [-1.6129290283004183, 51.52636605999458],
            [-1.5579973876754183, 51.52123937683341],
            [-1.578081768778934, 51.51568481872326],
            [-1.5981661498824495, 51.510129583177275],
            [-1.6246020019332308, 51.44769347893026],
            [-1.6280352294722933, 51.346588561060436],
            [-1.6678606689254183, 51.276197566092435],
            [-1.8079363525191683, 51.17299163650988],
            [-1.7612444579879183, 51.1066459055331],
            [-1.7131792724410433, 51.04581715572785],
            [-1.7543780029097933, 51.01926041733651],
            [-1.8093096435347933, 51.02379557195765],
            [-1.9006334960738558, 51.01731664383359],
            [-1.922949475077762, 50.97950484979051],
            [-1.8834673583785433, 50.94166223814069],
            [-1.8834673583785433, 50.910500056322725],
            [-1.8793474853316683, 50.8706513310606],
            [-1.8436419189254183, 50.79866410013527],
            [-1.8175493896285433, 50.71569800283251],
            [-1.5628039062301058, 50.71765439340002],
            [-1.325567883280887, 50.81070583986951],
            [-1.1575113952437777, 50.77039179165387],
            [-0.9400164306441683, 50.782169475484935],
            [-0.7862078368941683, 50.72395776305186],
            [-0.6653582275191683, 50.78694483381551],
            [-0.3577410400191683, 50.80799400710836],
            [-0.1352678954879183, 50.8080482453064],
            [0.09681828615270671, 50.766401903716286],
            [0.1963818847855192, 50.74035070379142],
            [0.28461583253942546, 50.736881094330755],
            [0.3234113037308317, 50.79074306601896],
            [0.3680432617386442, 50.81852859516198],
            [0.46091206667028484, 50.83523060384196],
            [0.5403054535111051, 50.84791491835197],
            [0.6033480941971403, 50.85338882251109],
            [0.6678283989151579, 50.8743272428994],
            [0.7467604458054167, 50.918569660727286],
            [0.7982266723831755, 50.9324875227737],
            [0.8878339111527067, 50.91821139363406],
            [0.973321276875363, 50.90826082341208],
            [0.9885991394241911, 50.91584063165895],
            [0.9687722503861051, 50.95770687651433],
            [0.9808314621170622, 50.997644007976305],
            [1.0093701660355192, 51.01681718887227],
            [1.044131594868527, 51.04434836390453],
            [1.0926259338577848, 51.06150721866856],
            [1.2074673950394255, 51.08200452963183],
            [1.4192975341995817, 51.150546003977844],
            [1.3986981689652067, 51.245233220567066],
            [1.448479968281613, 51.36843634027725],
            [1.4513123810013395, 51.3931875737073],
            [1.374493914814816, 51.399080026778826],
            [1.1617196380814176, 51.366405090335654],
            [0.9289897262772184, 51.350058873347194],
            [0.8202476083954435, 51.36002199597122],
            [0.7609439670761686, 51.38369818369176],
            [0.7304794370850187, 51.39622457872782],
            [0.6752956688126188, 51.39332606594184],
            [0.586900788517819, 51.4046653162547],
            [0.6028760254105192, 51.42285298990107],
            [0.7115376770218473, 51.433773366240146],
            [0.7542813598831755, 51.45324963897894],
            [0.7475865661820036, 51.48554688304269],
            [0.5025399505814176, 51.50168693231188],
            [0.7096064865311247, 51.53368043029121],
            [0.7888389408310514, 51.51946296830712],
            [0.8900440513809782, 51.53600331250618],
            [0.996742325993405, 51.574733836150735],
            [0.9841734945496183, 51.62819902367014],
            [0.922957438202725, 51.63104615931532],
            [0.9582673787792784, 51.72783875870484],
            [0.7903302490433317, 51.7190510294985]
          ]
        ])

        return turfbooleanPointInPolygon(point, poly)
      }

      return false
    }
  },
  methods: {
    async visible() {
      if (!this.shown) {
        this.shown = true

        const ret = await this.$api.bandit.choose({
          uid: this.key
        })

        if (ret.variant) {
          this.chosen = ret.variant

          this.$api.bandit.shown({
            uid: this.key,
            variant: ret.variant
          })
        }

        this.$emit('update:shown', true)
      }
    },
    async click() {
      await this.$api.bandit.chosen({
        uid: this.key,
        variant: this.chosen
      })

      window.open('https://www.lovejunk.com/rubbish-clearance/')
    }
  }
}
</script>
