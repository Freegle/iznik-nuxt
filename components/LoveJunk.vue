<template>
  <div v-observe-visibility="visible">
    <div v-if="src && show">
      <a @click="click">
        <b-card-img :src="src" fluid class="clickme" />
      </a>
      <div id="adnotice" class="d-flex justify-content-end text-muted small">
        Advertisement. Why am I seeing this?
      </div>
      <b-tooltip target="adnotice">
        Showing this generates a bit of income for Freegle, which helps us keep going.
      </b-tooltip>
    </div>
  </div>
</template>
<script>
import turfpoint from 'turf-point'
import turfpolygon from 'turf-polygon'
import turfbooleanPointInPolygon from '@turf/boolean-point-in-polygon'
import VueObserveVisibility from 'vue-observe-visibility'
import Vue from 'vue'

if (process.client) {
  Vue.use(VueObserveVisibility)
}

export default {
  props: {
    variant: {
      type: String,
      required: true
    }
  },
  data: function() {
    return {
      shown: false,
      chosen: null,
      uid: 'lovejunk6'
    }
  },
  computed: {
    key() {
      return this.uid + '-' + this.variant
    },
    src() {
      return 'https://www.ilovefreegle.org/lovejunk/' + this.chosen
    },
    show() {
      // We want to show the ad if the user's location is within the area LoveJunk cover.
      if (this.me && (this.me.lat || this.me.lng)) {
        // const point = turfpoint([51.508, -0.1281])
        const point = turfpoint([this.me.lat, this.me.lng])

        const poly = turfpolygon([
          [
            [51.7190510294985, 0.7903302490433317],
            [51.79725493114429, 0.9880841552933317],
            [51.752431759894385, 1.0320294677933317],
            [51.802775084804495, 1.3945782959183317],
            [51.92362407610417, 1.4055646240433317],
            [52.06779247828239, 1.5923322021683317],
            [52.177824902401916, 1.6252911865433317],
            [52.491663621971334, 1.7626202881058317],
            [52.73847256370084, 1.7021954834183317],
            [52.83813416626232, 1.5099347412308317],
            [52.91107430952959, 1.3726056396683317],
            [52.94915330484405, 1.1995709716995817],
            [52.96735315790375, 1.0485089599808317],
            [52.97066139913295, 0.8892072021683317],
            [52.983891832146234, 0.7518781006058317],
            [52.97562328623171, 0.5953229248245817],
            [52.91107430952961, 0.4662335693558317],
            [52.81324016593034, 0.3646100341995817],
            [52.67939858396759, 0.1490033447464567],
            [52.648581846780296, -0.1929461181441683],
            [52.62191200806287, -0.5280291259566683],
            [52.6702391209978, -0.6900774658004183],
            [52.896164713252155, -0.7202898681441683],
            [52.94005050556322, -0.8658587158004183],
            [52.85762450537018, -1.1473833740035433],
            [52.77981830711604, -1.3952624023238558],
            [52.743461066466594, -1.5470110595504183],
            [52.88456481322811, -1.7365252197066683],
            [52.97727712200352, -1.8244158447066683],
            [53.08958951814358, -2.0111834228316683],
            [53.25586697379751, -2.0633684814254183],
            [53.33056371909026, -2.1059405029097933],
            [53.33507417238548, -2.335966748026981],
            [53.34716803352868, -2.4811922729293245],
            [53.328615875905456, -2.8174769103804964],
            [53.27801771250202, -3.0169045150557894],
            [53.195143934737494, -3.075419586924686],
            [53.125296731635395, -2.9856192291060824],
            [52.95052373088115, -3.0449711501876253],
            [52.78985015662849, -3.158417862681522],
            [52.57853883908245, -3.2086931884566683],
            [52.459877868012846, -3.2224260986129183],
            [52.395399475285856, -3.1702410400191683],
            [52.38450420560836, -2.5495135009566683],
            [52.152554137389764, -2.4890886962691683],
            [51.962565683183975, -2.3270403564254183],
            [51.83333600746758, -2.5124346435347933],
            [51.67478889881335, -2.6264177978316683],
            [51.49901707965593, -2.7994524658004183],
            [51.381743570603476, -2.9601275146285433],
            [51.31226498074623, -3.0164324462691683],
            [51.31054812727073, -2.7088152587691683],
            [51.27963377873712, -2.4561297118941683],
            [51.27276109641657, -2.3023211181441683],
            [51.183322644486566, -2.2611223876754183],
            [51.06955419504036, -2.3380266845504183],
            [51.00738052886116, -2.3847185790816683],
            [50.976262405032635, -2.1649920165816683],
            [50.95377522734892, -2.0386492431441683],
            [50.9273821626731, -2.001055401591434],
            [50.9044383189659, -1.9936739623824495],
            [50.87065133106054, -1.9953905761519808],
            [50.84984715710331, -1.9878374755660433],
            [50.83423793490215, -1.9947039306441683],
            [50.8272988266055, -1.9974505126754183],
            [50.825563888348036, -1.9974505126754183],
            [50.829033700388685, -1.9947039306441683],
            [50.71961070230363, -1.8958269775191683],
            [50.71787176508872, -1.5607439697066683],
            [50.782169475484935, -0.9400164306441683],
            [50.72395776305186, -0.7862078368941683],
            [50.78694483381551, -0.6653582275191683],
            [50.80799400710836, -0.3577410400191683],
            [50.8080482453064, -0.1352678954879183],
            [50.766401903716286, 0.09681828615270671],
            [50.74035070379142, 0.1963818847855192],
            [50.736881094330755, 0.28461583253942546],
            [50.79074306601896, 0.3234113037308317],
            [50.81852859516198, 0.3680432617386442],
            [50.83523060384196, 0.46091206667028484],
            [50.84791491835197, 0.5403054535111051],
            [50.85338882251109, 0.6033480941971403],
            [50.8743272428994, 0.6678283989151579],
            [50.918569660727286, 0.7467604458054167],
            [50.9324875227737, 0.7982266723831755],
            [50.91821139363406, 0.8878339111527067],
            [50.90826082341208, 0.973321276875363],
            [50.91584063165895, 0.9885991394241911],
            [50.95770687651433, 0.9687722503861051],
            [50.997644007976305, 0.9808314621170622],
            [51.01681718887227, 1.0093701660355192],
            [51.04434836390453, 1.044131594868527],
            [51.06150721866856, 1.0926259338577848],
            [51.08200452963183, 1.2074673950394255],
            [51.150546003977844, 1.4192975341995817],
            [51.245233220567066, 1.3986981689652067],
            [51.36843634027725, 1.448479968281613],
            [51.3931875737073, 1.4513123810013395],
            [51.399080026778826, 1.374493914814816],
            [51.366405090335654, 1.1617196380814176],
            [51.350058873347194, 0.9289897262772184],
            [51.36002199597122, 0.8202476083954435],
            [51.38369818369176, 0.7609439670761686],
            [51.39622457872782, 0.7304794370850187],
            [51.39332606594184, 0.6752956688126188],
            [51.4046653162547, 0.586900788517819],
            [51.42285298990107, 0.6028760254105192],
            [51.433773366240146, 0.7115376770218473],
            [51.45324963897894, 0.7542813598831755],
            [51.48554688304269, 0.7475865661820036],
            [51.50168693231188, 0.5025399505814176],
            [51.53368043029121, 0.7096064865311247],
            [51.51946296830712, 0.7888389408310514],
            [51.53600331250618, 0.8900440513809782],
            [51.574733836150735, 0.996742325993405],
            [51.62819902367014, 0.9841734945496183],
            [51.63104615931532, 0.922957438202725],
            [51.72783875870484, 0.9582673787792784],
            [51.7190510294985, 0.7903302490433317]
          ]
        ])

        return turfbooleanPointInPolygon(point, poly)
      }

      return false
    }
  },
  methods: {
    async visible() {
      if (!this.shown) {
        this.shown = true

        const ret = await this.$api.bandit.choose({
          uid: this.key
        })

        if (ret.variant) {
          this.chosen = ret.variant

          this.$api.bandit.shown({
            uid: this.key,
            variant: ret.variant
          })
        }

        this.$emit('update:shown', true)
      }
    },
    async click() {
      await this.$api.bandit.chosen({
        uid: this.key,
        variant: this.chosen
      })

      window.open('https://www.lovejunk.com/rubbish-clearance/')
    }
  }
}
</script>
