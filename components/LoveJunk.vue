<template>
  <a v-if="show" @click="click">
    <b-card-img v-observe-visibility="visible" :src="src" fluid class="clickme" />
  </a>
</template>
<script>
import turfpoint from 'turf-point'
import turfpolygon from 'turf-polygon'
import turfbooleanPointInPolygon from '@turf/boolean-point-in-polygon'
import VueObserveVisibility from 'vue-observe-visibility'
import Vue from 'vue'

if (process.browser) {
  Vue.use(VueObserveVisibility)
}

export default {
  props: {
    variant: {
      type: String,
      required: true
    }
  },
  data: function() {
    return {
      shown: false
    }
  },
  computed: {
    src() {
      return this.variant === 'mobile'
        ? '/lovejunk/mobile.jpg'
        : '/lovejunk/desktop.jpg'
    },
    show() {
      // We want to show the ad if the user's location is within the area LoveJunk cover.
      if (this.me && (this.me.lat || this.me.lng)) {
        // const point = turfpoint([-0.1281, 51.508])
        const point = turfpoint([this.me.lng, this.me.lat])

        const poly = turfpolygon([
          [
            [0.7903302490433317, 51.7190510294985],
            [0.9880841552933317, 51.79725493114429],
            [1.119920092793337, 51.78196482440004],
            [1.108933764668337, 51.87532343646985],
            [0.988084155293337, 52.00062802644126],
            [0.856248217793337, 52.03443407303321],
            [0.779343920918337, 51.932939275167165],
            [0.67497380373087, 51.94309910551736],
            [0.482713061543337, 52.01753424304129],
            [0.372849780293337, 51.96002704361278],
            [0.257493334980837, 51.92955215375683],
            [0.043259936543331, 51.939712751039984],
            [-0.1325213134563, 52.02767490736911],
            [-0.22041193845663, 52.10871747603098],
            [-0.35224787595663, 52.17614063120053],
            [-0.47859064939413, 52.21991095781428],
            [-0.64887873533163, 52.23337007960059],
            [-0.75874201658163, 52.179509109827585],
            [-0.8905779540816683, 52.14581284282836],
            [-1.0224138915816683, 52.1019695458063],
            [-1.0608660400191683, 52.04794933930252],
            [-1.0334002197066683, 51.98371542229207],
            [-1.0059343993941683, 51.916001111448324],
            [-1.0773455322066683, 51.861756027208116],
            [-1.1267840087691683, 51.83800321211513],
            [-1.1103045165816683, 51.77346808086396],
            [-1.0993181884566683, 51.73266143795429],
            [-1.0059343993941683, 51.708840533966054],
            [-0.8960711181441683, 51.68160127529278],
            [-0.8686052978316683, 51.63730250760835],
            [-0.7587420165816683, 51.55540636310996],
            [-0.7862078368941683, 51.48362606218378],
            [-0.7477556884566683, 51.41173259627206],
            [-0.7202898681441683, 51.32942998245802],
            [-0.7202898681441683, 51.2572938019306],
            [-0.7202898681441683, 50.99182407501101],
            [-0.9400164306441683, 50.782169475484935],
            [-0.7862078368941683, 50.72395776305186],
            [-0.6653582275191683, 50.78694483381551],
            [-0.3577410400191683, 50.80799400710836],
            [-0.1352678954879183, 50.8080482453064],
            [0.09681828615270671, 50.766401903716286],
            [0.05905278322301921, 50.83585058772428],
            [0.11158116457067546, 50.98479360189186],
            [0.1970685302933317, 51.0849767454035],
            [0.3268445312698942, 51.07032274799662],
            [0.43567784425817546, 51.104402648496354],
            [0.5664838134964567, 51.14190394674288],
            [0.796166735859738, 51.08630440820152],
            [1.0093701660355192, 51.01681718887227],
            [1.1539090454300505, 51.03884883419102],
            [1.4192975341995817, 51.150546003977844],
            [1.3986981689652067, 51.245233220567066],
            [1.448479968281613, 51.36843634027725],
            [1.374493914814816, 51.399080026778826],
            [1.1617196380814176, 51.366405090335654],
            [0.9289897262772184, 51.350058873347194],
            [0.6752956688126188, 51.39332606594184],
            [0.586900788517819, 51.4046653162547],
            [0.6028760254105192, 51.42285298990107],
            [0.7542813598831755, 51.45324963897894],
            [0.7475865661820036, 51.48554688304269],
            [0.5025399505814176, 51.50168693231188],
            [0.7096064865311247, 51.53368043029121],
            [0.8900440513809782, 51.53600331250618],
            [0.996742325993405, 51.574733836150735],
            [0.9841734945496183, 51.62819902367014],
            [0.922957438202725, 51.63104615931532],
            [0.9582673787792784, 51.72783875870484],
            [0.7903302490433317, 51.7190510294985]
          ]
        ])

        console.log(
          'Check ',
          turfbooleanPointInPolygon,
          turfbooleanPointInPolygon(point, poly)
        )
        return turfbooleanPointInPolygon(point, poly)
      }

      return false
    }
  },
  methods: {
    visible() {
      if (!this.shown) {
        this.shown = true

        this.$api.bandit.shown({
          uid: 'lovejunk',
          variant: this.variant
        })
      }
    },
    async click() {
      await this.$api.bandit.chosen({
        uid: 'lovejunk',
        variant: this.variant
      })

      window.open('https://www.lovejunk.com/rubbish-clearance/')
    }
  }
}
</script>
